package edu.note.jsonutil.diff;

import static java.math.BigDecimal.valueOf;
import static java.util.Collections.singletonMap;
import static net.javacrumbs.jsonunit.core.Option.FAIL_FAST;
import static net.javacrumbs.jsonunit.core.Option.IGNORING_ARRAY_ORDER;
import static net.javacrumbs.jsonunit.core.Option.IGNORING_EXTRA_ARRAY_ITEMS;
import static net.javacrumbs.jsonunit.core.Option.IGNORING_EXTRA_FIELDS;
import static net.javacrumbs.jsonunit.core.listener.Difference.Type.DIFFERENT;
import static net.javacrumbs.jsonunit.core.listener.Difference.Type.EXTRA;
import static net.javacrumbs.jsonunit.core.listener.Difference.Type.MISSING;
import static net.javacrumbs.jsonunit.core.util.ResourceUtils.resource;
import static org.assertj.core.api.Assertions.assertThat;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.List;

import org.hamcrest.BaseMatcher;
import org.hamcrest.Description;
// import org.jspecify.annotations.Nullable;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.Timeout;

import net.javacrumbs.jsonunit.core.Configuration;
import net.javacrumbs.jsonunit.core.NumberComparator;
import net.javacrumbs.jsonunit.core.ParametrizedMatcher;
import net.javacrumbs.jsonunit.core.internal.Diff;
import net.javacrumbs.jsonunit.core.listener.Difference;
import net.javacrumbs.jsonunit.core.listener.DifferenceContext;
import net.javacrumbs.jsonunit.core.listener.DifferenceListener;

/**
 * @author jackylee
 * @date 2025-11-28 14:40
 */
public class DifferenceTest {

    @Test
    void shouldSeeEmptyDiffNodes() {
        Diff diff = Diff.create("{}", "{}", "", "", commonConfig());
        diff.similar();
        assertThat(listener.getDifferenceList()).isEmpty();
    }

    @Test
    void shouldSeeRemovedNode() {
        Diff diff = Diff.create("{\"test\": \"1\"}", "{}", "", "", commonConfig());
        diff.similar();
        assertThat(listener.getDifferenceList()).hasSize(1);
        Difference difference = listener.getDifferenceList().get(0);
        assertThat(difference.getType()).isEqualTo(DifferenceImpl.Type.MISSING);
        assertThat(difference.getActualPath()).isEqualTo(null);
        assertThat(difference.getExpected()).isEqualTo("1");
        assertThat(difference.getActual()).isNull();
    }

    @Test
    void shouldSeeAddedNode() {
        Diff diff = Diff.create("{}", "{\"test\": \"1\"}", "", "", commonConfig());
        diff.similar();
        assertThat(listener.getDifferenceList()).hasSize(1);
        Difference difference = listener.getDifferenceList().get(0);
        assertThat(difference.getType()).isEqualTo(EXTRA);
        assertThat(difference.getActualPath()).isEqualTo("test");
        assertThat(difference.getActual()).isEqualTo("1");
        assertThat(difference.getExpected()).isNull();
    }

    @Test
    void shouldSeeEmptyForCheckAnyNode() {
        Diff diff = Diff.create("{\"test\": \"${json-unit.ignore}\"}", "{\"test\":\"1\"}", "", "", commonConfig());
        diff.similar();
        assertThat(listener.getDifferenceList()).isEmpty();
    }

    @Test
    void shouldSeeEmptyForCheckAnyBooleanNode() {
        Diff diff = Diff.create("{\"test\": \"${json-unit.any-boolean}\"}", "{\"test\": true}", "", "", commonConfig());
        diff.similar();
        assertThat(listener.getDifferenceList()).isEmpty();
    }

    @Test
    void shouldSeeEmptyForCheckAnyNumberNode() {
        Diff diff = Diff.create("{\"test\": \"${json-unit.any-number}\"}", "{\"test\": 11}", "", "", commonConfig());
        diff.similar();
        assertThat(listener.getDifferenceList()).isEmpty();
    }

    @Test
    void shouldSeeEmptyForCheckAnyStringNode() {
        Diff diff = Diff.create("{\"test\": \"${json-unit.any-string}\"}", "{\"test\": \"1\"}", "", "", commonConfig());
        diff.similar();
        assertThat(listener.getDifferenceList()).isEmpty();
    }

    @Test
    void shouldSeeChangedStringNode() {
        Diff diff = Diff.create("{\"test\": \"1\"}", "{\"test\": \"2\"}", "", "", commonConfig());
        diff.similar();
        assertThat(listener.getDifferenceList()).hasSize(1);
        Difference difference = listener.getDifferenceList().get(0);
        assertThat(difference.getType()).isEqualTo(DIFFERENT);
        assertThat(difference.getActualPath()).isEqualTo("test");
        assertThat(difference.getExpected()).isEqualTo("1");
        assertThat(difference.getActual()).isEqualTo("2");
    }

    @Test
    void shouldSeeChangedNumberNode() {
        Diff diff = Diff.create("{\"test\": 1}", "{\"test\": 2 }", "", "", commonConfig());
        diff.similar();
        assertThat(listener.getDifferenceList()).hasSize(1);
        Difference difference = listener.getDifferenceList().get(0);
        assertThat(difference.getType()).isEqualTo(DIFFERENT);
        assertThat(difference.getActualPath()).isEqualTo("test");
        assertThat(difference.getExpected()).isEqualTo(new BigDecimal(1));
        assertThat(difference.getActual()).isEqualTo(new BigDecimal(2));
    }

    @Test
    void shouldSeeChangedBooleanNode() {
        Diff diff = Diff.create("{\"test\": true}", "{\"test\": false}", "", "", commonConfig());
        diff.similar();
        assertThat(listener.getDifferenceList()).hasSize(1);
        Difference difference = listener.getDifferenceList().get(0);
        assertThat(difference.getType()).isEqualTo(DIFFERENT);
        assertThat(difference.getActualPath()).isEqualTo("test");
        assertThat(difference.getExpected()).isEqualTo(true);
        assertThat(difference.getActual()).isEqualTo(false);
    }

    @Test
    void shouldSeeChangedStructureNode() {
        Diff diff = Diff.create("{\"test\": \"1\"}", "{\"test\": false}", "", "", commonConfig());
        diff.similar();
        assertThat(listener.getDifferenceList()).hasSize(1);
        Difference difference = listener.getDifferenceList().get(0);
        assertThat(difference.getType()).isEqualTo(DIFFERENT);
        assertThat(difference.getActualPath()).isEqualTo("test");
        assertThat(difference.getExpected()).isEqualTo("1");
        assertThat(difference.getActual()).isEqualTo(false);
    }

    @Test
    void shouldSeeChangedArrayNode() {
        Diff diff = Diff.create("[1, 1]", "[1, 2]", "", "", commonConfig());
        diff.similar();
        assertThat(listener.getDifferenceList()).hasSize(1);
        Difference difference = listener.getDifferenceList().get(0);
        assertThat(difference.getType()).isEqualTo(DIFFERENT);
        assertThat(difference.getActualPath()).isEqualTo("[1]");
        assertThat(difference.getExpected()).isEqualTo(valueOf(1));
        assertThat(difference.getActual()).isEqualTo(valueOf(2));
    }

    @Test
    void shouldSeeRemovedArrayNode() {
        Diff diff = Diff.create("[1, 2]", "[1]", "", "", commonConfig());
        diff.similar();
        assertThat(listener.getDifferenceList()).hasSize(1);
        Difference difference = listener.getDifferenceList().get(0);
        assertThat(difference.getType()).isEqualTo(DifferenceImpl.Type.MISSING);
        assertThat(difference.getActualPath()).isNull();
        assertThat(difference.getExpectedPath()).isEqualTo("[1]");
        assertThat(difference.getExpected()).isEqualTo(valueOf(2));
        assertThat(difference.getActual()).isNull();
    }

    @Test
    void shouldSeeAddedArrayNode() {
        Diff diff = Diff.create("[1]", "[1, 2]", "", "", commonConfig());
        diff.similar();
        assertThat(listener.getDifferenceList()).hasSize(1);
        Difference difference = listener.getDifferenceList().get(0);
        assertThat(difference.getType()).isEqualTo(EXTRA);
        assertThat(difference.getActual()).isEqualTo(valueOf(2));
        assertThat(difference.getActualPath()).isEqualTo("[1]");
        assertThat(difference.getExpectedPath()).isNull();
        assertThat(difference.getExpected()).isNull();
    }

    @Test
    void shouldSeeObjectDiffNodes() {
        Diff diff = Diff.create(
                "{\"test\": { \"test1\": \"1\"}}", "{\"test\": { \"test1\": \"2\"} }", "", "", commonConfig());
        diff.similar();
        assertThat(listener.getDifferenceList()).hasSize(1);
        Difference difference = listener.getDifferenceList().get(0);
        assertThat(difference.getType()).isEqualTo(DIFFERENT);
        assertThat(difference.getActualPath()).isEqualTo("test.test1");
        assertThat(difference.getExpected()).isEqualTo("1");
        assertThat(difference.getActual()).isEqualTo("2");
    }

    @Test
    void shouldSeeNullNode() {
        Diff diff = Diff.create(null, null, "", "", commonConfig());
        diff.similar();
        assertThat(listener.getDifferenceList()).isEmpty();
    }

    @Test
    void shouldWorkWhenIgnoringArrayOrder() {
        Diff diff = Diff.create(
                "{\"test\": [[1,2],[2,3]]}",
                "{\"test\":[[4,2],[1,2]]}",
                "",
                "",
                commonConfig().when(IGNORING_ARRAY_ORDER));
        diff.similar();
        assertThat(listener.getDifferenceList()).hasSize(1);
        Difference difference = listener.getDifferenceList().get(0);
        assertThat(difference.getType()).isEqualTo(DIFFERENT);
        assertThat(difference.getActualPath()).isEqualTo("test[0][0]");
        assertThat(difference.getActual()).isEqualTo(valueOf(4));
        assertThat(difference.getExpectedPath()).isEqualTo("test[1][1]");
        assertThat(difference.getExpected()).isEqualTo(valueOf(3));
    }

    @Test
    void shouldSeeActualSource() {
        Diff diff = Diff.create("{\"test\": \"1\"}", "{}", "", "", commonConfig());
        diff.similar();
        assertThat(listener.getActualSource()).asString().isEqualTo("{}");
    }

    @Test
    void shouldSeeExpectedSource() {
        Diff diff = Diff.create("{\"test\": \"1\"}", "{}", "", "", commonConfig());
        diff.similar();
        assertThat(listener.getExpectedSource()).isEqualTo(singletonMap("test", "1"));
    }

    @Test
    void shouldMatchWithLineSeparatorCustomMatcher() {
        // Configuration cfg = commonConfig().withMatcher("equalTo", new
        // EqualsMatcher());
        Diff diff = Diff.create(
                "{\"key\": \"${json-unit.matches:equalTo}separated \\n line\"}",
                "{\"key\": \"separated \\n line\"}",
                "",
                "",
                cfg);
        assertThat(diff.similar()).isTrue();
        // assertThat(listener.getDifferenceList()).isEmpty();
    }

    @Test
    void shouldBeAwareOfRootMissingElement() {
        Diff diff = Diff.create("foo", "{\"test\":-1}", "", "path.node", commonConfig());
        assertThat(diff.similar()).isFalse();

        // assertThat(listener.getDifferenceList()).hasSize(1);
        // Difference difference = listener.getDifferenceList().get(0);
        // assertThat(difference.getType()).isEqualTo(MISSING);
        // assertThat(difference.getExpectedPath()).isEqualTo("path.node");
        // assertThat(difference.getActualPath()).isEqualTo(null);
        // assertThat(difference.getExpected()).isEqualTo("foo");
        // assertThat(difference.getActual()).isEqualTo(null);
    }

    @Test
    void shouldWorkWhenExtraArrayItemsAreNotAllowed() {
        Diff diff = Diff.create(
                "{\"test\": [2, 3]}",
                "{\"test\": [1, 2, 3]}",
                "",
                "",
                commonConfig().when(IGNORING_ARRAY_ORDER));
        assertThat(diff.similar()).isFalse();

        // assertThat(listener.getDifferenceList()).hasSize(1);
        // Difference difference = listener.getDifferenceList().get(0);
        // assertThat(difference.getType()).isEqualTo(EXTRA);
        // assertThat(difference.getExpectedPath()).isEqualTo(null);
        // assertThat(difference.getActualPath()).isEqualTo("test[0]");
        // assertThat(difference.getExpected()).isEqualTo(null);
        // assertThat(difference.getActual()).isEqualTo(valueOf(1));
    }

    @Test
    void shouldWorkWhenExtraArrayItemsAreAllowed() {
        Diff diff = Diff.create(
                "{\"test\": [2, 3]}",
                "{\"test\": [1, 2, 3]}",
                "",
                "",
                commonConfig().when(IGNORING_ARRAY_ORDER, IGNORING_EXTRA_ARRAY_ITEMS));
        assertThat(diff.similar()).isTrue();
    }

    private Configuration commonConfig() {
        return Configuration.empty().withDifferenceListener(listener);
    }

    @SuppressWarnings("BigDecimalEquals")
    private static class NormalisedNumberComparator implements NumberComparator {
        @Override
        public boolean compare(BigDecimal expectedValue, BigDecimal actualValue, BigDecimal tolerance) {
            BigDecimal normalisedExpectedValue = expectedValue.stripTrailingZeros();
            BigDecimal normalisedActualValue = actualValue.stripTrailingZeros();
            if (tolerance != null) {
                BigDecimal diff = normalisedExpectedValue.subtract(normalisedActualValue).abs();
                return diff.compareTo(tolerance) <= 0;
            } else {
                return normalisedExpectedValue.equals(normalisedActualValue);
            }
        }
    }
}
